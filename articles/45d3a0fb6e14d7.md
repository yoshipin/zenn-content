---
title: "ã‚†ã‚‹ã€œã£ã¨ç†è§£ Zustand"
emoji: "ğŸ§¸"
type: "tech"
topics:
  - "react"
  - "typescript"
  - "zustand"
published: true
published_at: "2025-03-15 10:37"
---

Stateç®¡ç†ã¨ã—ã¦Hookãƒ™ãƒ¼ã‚¹ã§é–‹ç™ºä½“é¨“ãŒè‰¯ã„ã¨å™‚ã®Zustandã‚’èª¿æŸ»ã—ãŸæ™‚ã®ã¾ã¨ã‚

### åŸºæœ¬çš„ãªä½¿ã„æ–¹

```tsx
import { create, createSelectors } from 'zustand'

type State = {
  firstName: string
  lastName: string
}

type Action = {
  updateFirstName: (firstName: State['firstName']) => void
  updateLastName: (lastName: State['lastName']) => void
}

const usePersonStore = create<State & Action>((set) => ({
  firstName: '',
  lastName: '',
  updateFirstName: (firstName) => set(() => ({ firstName: firstName })),
  updateLastName: (lastName) => set(() => ({ lastName: lastName })),
}))
```

Typescriptã§ã¯åŸºæœ¬çš„ã«å‹ã‚’æŒ‡å®šã—ãŸæ–¹ãŒè‰¯ã„ã€‚

### combineã«ã‚ˆã‚‹Stateã®å‹æ¨è«–

å‹å®šç¾©ãŒé¢å€’ã§ã‚ã‚Œã°ä»¥ä¸‹ã®ã‚ˆã†ã«ã€middlewareã®combineã‚’ä½¿ã†ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã‚‹ã€‚å¤§ä½“ã¯ã“ã‚Œã§ã†ã¾ãã„ããŒã€`replace` ã‚„ `Object.keys` ã‚’ä½¿ç”¨ã™ã‚‹éš›ãªã©å‹ä¸æ•´åˆãŒèµ·ãã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã®ã§æ³¨æ„

```tsx
import { create, ExtractState } from 'zustand'
import { combine } from 'zustand/middleware'

const useBearStore = create(
  combine({ bears: 0 }, (set) => ({
    increase: (by: number) => set((state) => ({ bears: state.bears + by })),
  })),
)

// ExtractStateã§å‹ã®æŠ½å‡ºã‚‚å¯èƒ½
type BearState = ExtractState<typeof useBearStore>
```

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®æ´»ç”¨

ã‚¹ãƒˆã‚¢ã®çŠ¶æ…‹ã‚„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ã€è¿½åŠ ã®å‡¦ç†ã‚’æŒŸã¿è¾¼ã‚€ã“ã¨ãŒã§ãã‚‹ã€‚

- `devtools`â€¦Redux DevTools ã¨çµ±åˆã—Stateã®å¤‰åŒ–ã‚’ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã§å¯è¦–åŒ–
- `persist`â€¦Stateã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«æ°¸ç¶šåŒ–
    - stateã®ä¸€éƒ¨ã ã‘ã‚’ä¿å­˜ã™ã‚‹ã¨ãã¯`partialize`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†
- `immer`â€¦Stateã®æ›´æ–°ã‚’ç°¡æ˜“ã«ã™ã‚‹

Stateã®æ›´æ–°ã§ãƒã‚¹ãƒˆã™ã‚‹å ´åˆã¯`immer`ã‚„`optics-ts`ã‚„`Ramda`ã‚’ä½¿ã†

> https://zustand.docs.pmnd.rs/guides/updating-state#deeply-nested-object
> 

### è¤‡æ•°Storeã®ç®¡ç†

ã‚¹ãƒ©ã‚¤ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è¤‡æ•°ã®ã‚¹ãƒˆã‚¢ã‚’ï¼‘ã¤ã«çµ±åˆã™ã‚‹ã€‚

```tsx
import { create } from 'zustand'

const createFishSlice = (set) => ({
  fishes: 0,
  addFish: () => set((state) => ({ fishes: state.fishes + 1 })),
})

const createBearSlice = (set) => ({
  bears: 0,
  addBear: () => set((state) => ({ bears: state.bears + 1 })),
  eatFish: () => set((state) => ({ fishes: state.fishes - 1 })),
})

// çµ±åˆ
export const useBoundStore = create((...a) => ({
  ...createBearSlice(...a),
  ...createFishSlice(...a),
}))

// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´ã§ã®ä½¿ç”¨
import { useBoundStore } from './stores/useBoundStore'

function App() {
  const bears = useBoundStore((state) => state.bears)
  const fishes = useBoundStore((state) => state.fishes)
  const addBear = useBoundStore((state) => state.addBear)
  return (
    <div>
      <h2>Number of bears: {bears}</h2>
      <h2>Number of fishes: {fishes}</h2>
      <button onClick={() => addBear()}>Add a bear</button>
    </div>
  )
}

```

### Selector

Storeã‹ã‚‰ã®è¨ˆç®—ã•ã‚ŒãŸStateã‚’ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã™ã‚‹å ´åˆã¯Selectorã‚’ä½¿ã†ã®ãŒãŠã™ã™ã‚ã€‚ä¸‹è¨˜ã®ä¾‹ã§ã¯ã€Œã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼=`useMeals((state) => Object.keys(state))` ã€

ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é˜²ããŸã‚ã«ã¯`useShallow`ã‚’ä½¿ã†

```tsx
import { create } from 'zustand'
import { useShallow } from 'zustand/react/shallow'

const useMeals = create(() => ({
  papaBear: 'large porridge-pot',
  mamaBear: 'middle-size porridge pot',
  littleBear: 'A little, small, wee pot',
}))

export const BearNames = () => {
  // â†“Selector
  // useShallowã¯ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é˜²ã
  const names = useMeals(useShallow((state) => Object.keys(state)))

  return <div>{names.join(', ')}</div>
}
```

> https://zustand.docs.pmnd.rs/guides/prevent-rerenders-with-use-shallow
> 

ãªã‚‹ã¹ãå†åˆ©ç”¨æ€§ã®é«˜ã„ã‚‚ã®ã«ã¤ã„ã¦ã¯`createSelectors`ã‚’æ›¸ãã®ãŒãŠã™ã™ã‚

```tsx
// Selector(ä½¿ã„æ‰€ãªã‚‹ã¹ãå†åˆ©ç”¨æ€§ã®é«˜ã„ã‚‚ã®ã«é™ã‚‹)
// ä»¥ä¸‹ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªä¾‹
const useBearStoreBase = create<BearState>()((set) => ({
  bears: 0,
  increase: (by) => set((state) => ({ bears: state.bears + by })),
  increment: () => set((state) => ({ bears: state.bears + 1 })),
}))

const useBearStore = createSelectors(useBearStoreBase)

// get the property
const bears = useBearStore.use.bears()

// get the action
const increment = useBearStore.use.increment()
```

> https://zustand.docs.pmnd.rs/guides/auto-generating-selector
> 

### å‰¯ä½œç”¨ ~StoreA ã®å€¤ã®å¤‰åŒ–ã‚’ãƒˆãƒªã‚¬ãƒ¼ã« StoreB ã®å€¤ã‚’å¤‰æ›´ã—ãŸã„~

Storeä¾å­˜ã®å‰¯ä½œç”¨ã‚’ã©ã†æ›¸ãã‹èª¿ã¹ãŸã¨ã“ã‚ã€ä»¥ä¸‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã„ãšã‚Œã‹ã‚’æ¡ç”¨ã™ã‚‹ã¨è‰¯ã•ãã†ã€‚

- **StoreA ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…**

```tsx
import { create } from 'zustand';

const useStoreA = create((set) => ({
  valueA: 0,
  setValueA: (newValue: number) => {
    set({ valueA: newValue });
    useStoreB.getState().setValueB(newValue * 2); // StoreB ã®å€¤ã‚’å¤‰æ›´
  },
}));

const useStoreB = create((set) => ({
  valueB: 0,
  setValueB: (newValue: number) => set({ valueB: newValue }),
}));

export { useStoreA, useStoreB };
```

- **ã‚«ã‚¹ã‚¿ãƒ ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**

```tsx
import { create, StoreApi, UseBoundStore } from 'zustand';

type Middleware<S extends object> = (
  config: (set: StoreApi<S>['setState'], get: StoreApi<S>['getState'], api: StoreApi<S>) => S,
) => (set: StoreApi<S>['setState'], get: StoreApi<S>['getState'], api: StoreApi<S>) => S;

const syncStoreAWithStoreB: Middleware<any> = (config) => (set, get, api) => {
  const initialState = config(set, get, api);

  return {
    ...initialState,
    setValueA: (newValue: number) => {
      set((state) => ({ ...state, valueA: newValue }));
      useStoreB.getState().setValueB(newValue * 2);
    },
  };
};

const useStoreA = create(syncStoreAWithStoreB((set) => ({
  valueA: 0,
  setValueA: (newValue: number) => set({ valueA: newValue }),
})));

const useStoreB = create((set) => ({
  valueB: 0,
  setValueB: (newValue: number) => set({ valueB: newValue }),
}));

export { useStoreA, useStoreB };
```

- **React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§ã® `useEffect`**

```tsx
import React, { useEffect } from 'react';
import { useStoreA, useStoreB } from './stores';

const MyComponent = () => {
  const valueA = useStoreA((state) => state.valueA);

  useEffect(() => {
    useStoreB.getState().setValueB(valueA * 2);
  }, [valueA]);

  return <div>...</div>;
};

export default MyComponent;
```